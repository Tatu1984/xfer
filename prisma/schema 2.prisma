generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum Role {
  SUPER_ADMIN
  ADMIN
  VENDOR
  USER
}

enum AccountStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CLOSED
}

enum KYCStatus {
  NOT_STARTED
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  EXPIRED
}

enum KYBStatus {
  NOT_STARTED
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  EXPIRED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER_IN
  TRANSFER_OUT
  PAYMENT
  REFUND
  PAYOUT
  FEE
  ADJUSTMENT
  HOLD
  RELEASE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REVERSED
  ON_HOLD
}

enum PaymentMethodType {
  BANK_ACCOUNT
  DEBIT_CARD
  CREDIT_CARD
}

enum PaymentMethodStatus {
  PENDING_VERIFICATION
  VERIFIED
  FAILED
  EXPIRED
  REMOVED
}

enum DisputeType {
  ITEM_NOT_RECEIVED
  NOT_AS_DESCRIBED
  UNAUTHORIZED
  DUPLICATE
  SUBSCRIPTION_CANCELLED
  OTHER
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  WAITING_SELLER_RESPONSE
  WAITING_BUYER_RESPONSE
  ESCALATED
  RESOLVED_BUYER_FAVOR
  RESOLVED_SELLER_FAVOR
  CLOSED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertStatus {
  NEW
  INVESTIGATING
  ESCALATED
  RESOLVED
  FALSE_POSITIVE
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
  PAST_DUE
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

enum OrderStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  PARTIALLY_CAPTURED
  VOIDED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum MoneyRequestStatus {
  PENDING
  COMPLETED
  DECLINED
  CANCELLED
  EXPIRED
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id                String        @id @default(cuid())
  email             String        @unique
  emailVerified     DateTime?
  passwordHash      String?
  phone             String?       @unique
  phoneVerified     DateTime?
  firstName         String?
  lastName          String?
  displayName       String?
  avatarUrl         String?
  dateOfBirth       DateTime?
  country           String?
  addressLine1      String?
  addressLine2      String?
  city              String?
  state             String?
  postalCode        String?
  role              Role          @default(USER)
  status            AccountStatus @default(PENDING)
  locale            String        @default("en")
  timezone          String        @default("UTC")
  preferredCurrency String        @default("USD")
  notificationPreferences Json?
  mfaEnabled        Boolean       @default(false)
  mfaSecret         String?
  lastLoginAt       DateTime?
  lastLoginIp       String?
  failedLoginAttempts Int         @default(0)
  lockedUntil       DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?

  // Relations
  accounts          Account[]
  sessions          Session[]
  wallets           Wallet[]
  kycVerification   KYCVerification?
  paymentMethods    PaymentMethod[]
  sentTransactions  Transaction[] @relation("SentTransactions")
  receivedTransactions Transaction[] @relation("ReceivedTransactions")
  disputes          Dispute[]     @relation("DisputeCreator")
  disputeResponses  Dispute[]     @relation("DisputeRespondent")
  riskProfile       RiskProfile?
  complianceAlerts  ComplianceAlert[]
  activityLogs      ActivityLog[]
  notifications     Notification[]
  devices           Device[]
  business          Business?
  supportTickets    SupportTicket[]
  apiKeys           APIKey[]
  sentMoneyRequests MoneyRequest[] @relation("RequestsSent")
  receivedMoneyRequests MoneyRequest[] @relation("RequestsReceived")
  subscriptions     Subscription[]

  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([status])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  userAgent    String?
  ipAddress    String?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  type       String   @default("email") // email, phone, password_reset, mfa

  @@unique([identifier, token])
}

model Device {
  id            String    @id @default(cuid())
  userId        String
  deviceId      String
  deviceName    String?
  deviceType    String?
  browser       String?
  os            String?
  isTrusted     Boolean   @default(false)
  lastUsedAt    DateTime?
  createdAt     DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId])
}

// ============================================
// KYC/KYB VERIFICATION
// ============================================

model KYCVerification {
  id                String    @id @default(cuid())
  userId            String    @unique
  status            KYCStatus @default(NOT_STARTED)
  level             Int       @default(0) // 0-3 verification levels

  // Identity Documents
  documentType      String?   // passport, drivers_license, national_id
  documentNumber    String?
  documentCountry   String?
  documentFrontUrl  String?
  documentBackUrl   String?
  documentExpiryDate DateTime?

  // Selfie/Liveness
  selfieUrl         String?
  livenessScore     Float?
  faceMatchScore    Float?

  // Address Verification
  addressLine1      String?
  addressLine2      String?
  city              String?
  state             String?
  postalCode        String?
  country           String?
  addressProofUrl   String?
  addressVerified   Boolean   @default(false)

  // Verification Results
  verifiedAt        DateTime?
  verifiedBy        String?   // Admin ID who verified
  rejectionReason   String?
  expiresAt         DateTime?

  // Watchlist Screening
  sanctionsChecked  Boolean   @default(false)
  pepChecked        Boolean   @default(false)
  adverseMediaChecked Boolean @default(false)
  lastScreeningDate DateTime?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Business {
  id                  String    @id @default(cuid())
  userId              String    @unique
  kybStatus           KYBStatus @default(NOT_STARTED)

  // Business Details
  legalName           String?
  tradingName         String?
  registrationNumber  String?
  taxId               String?
  businessType        String?   // sole_proprietor, llc, corporation, partnership
  industry            String?
  mcc                 String?   // Merchant Category Code
  website             String?

  // Business Address
  addressLine1        String?
  addressLine2        String?
  city                String?
  state               String?
  postalCode          String?
  country             String?

  // Documents
  registrationDocUrl  String?
  taxDocUrl           String?

  // Beneficial Owners
  beneficialOwners    Json?     // Array of UBO details

  // Verification
  verifiedAt          DateTime?
  verifiedBy          String?
  rejectionReason     String?

  // Merchant Settings
  statementDescriptor String?
  supportEmail        String?
  supportPhone        String?
  refundPolicy        String?
  description         String?
  settings            Json?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  merchantOrders Order[]
  subscriptionPlans SubscriptionPlan[]
  payouts        Payout[]
  invoices       Invoice[]
  webhooks       Webhook[]
  products       Product[]
}

// ============================================
// WALLET & BALANCES
// ============================================

model Wallet {
  id               String   @id @default(cuid())
  userId           String
  currency         String   @default("USD")
  balance          Decimal  @db.Decimal(20, 8) @default(0)
  availableBalance Decimal  @db.Decimal(20, 8) @default(0)
  pendingBalance   Decimal  @db.Decimal(20, 8) @default(0)
  reservedBalance  Decimal  @db.Decimal(20, 8) @default(0)
  isDefault        Boolean  @default(false)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  ledgerEntries LedgerEntry[]

  @@unique([userId, currency])
  @@index([userId])
  @@index([currency])
}

model LedgerEntry {
  id            String   @id @default(cuid())
  walletId      String
  transactionId String?
  entryType     String   // debit, credit
  amount        Decimal  @db.Decimal(20, 8)
  balanceBefore Decimal  @db.Decimal(20, 8)
  balanceAfter  Decimal  @db.Decimal(20, 8)
  description   String?
  reference     String?
  createdAt     DateTime @default(now())

  wallet      Wallet       @relation(fields: [walletId], references: [id])
  transaction Transaction? @relation(fields: [transactionId], references: [id])

  @@index([walletId])
  @@index([transactionId])
  @@index([createdAt])
}

// ============================================
// PAYMENT METHODS
// ============================================

model PaymentMethod {
  id              String              @id @default(cuid())
  userId          String
  type            PaymentMethodType
  status          PaymentMethodStatus @default(PENDING_VERIFICATION)
  isDefault       Boolean             @default(false)

  // Bank Account Details (encrypted in practice)
  bankName        String?
  bankCountry     String?
  accountType     String?             // checking, savings
  accountLast4    String?
  routingNumber   String?

  // Card Details (tokenized - never store full card)
  cardBrand       String?             // visa, mastercard, amex
  cardLast4       String?
  cardExpMonth    Int?
  cardExpYear     Int?
  cardFingerprint String?
  billingAddress  Json?

  // Verification
  verifiedAt      DateTime?
  expiresAt       DateTime?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId])
  @@index([type])
}

// ============================================
// TRANSACTIONS
// ============================================

model Transaction {
  id                String            @id @default(cuid())
  referenceId       String            @unique @default(cuid())
  idempotencyKey    String?           @unique

  type              TransactionType
  status            TransactionStatus @default(PENDING)

  senderId          String?
  receiverId        String?
  walletId          String
  paymentMethodId   String?

  amount            Decimal           @db.Decimal(20, 8)
  currency          String
  fee               Decimal           @db.Decimal(20, 8) @default(0)
  netAmount         Decimal           @db.Decimal(20, 8)

  // FX Details
  exchangeRate      Decimal?          @db.Decimal(20, 8)
  originalAmount    Decimal?          @db.Decimal(20, 8)
  originalCurrency  String?

  description       String?
  note              String?
  metadata          Json?

  // Risk & Compliance
  riskScore         Float?
  riskFlags         String[]
  requiresReview    Boolean           @default(false)
  reviewedBy        String?
  reviewedAt        DateTime?

  // Processing
  processedAt       DateTime?
  failureReason     String?
  externalRef       String?           // External processor reference

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  sender        User?          @relation("SentTransactions", fields: [senderId], references: [id])
  receiver      User?          @relation("ReceivedTransactions", fields: [receiverId], references: [id])
  wallet        Wallet         @relation(fields: [walletId], references: [id])
  paymentMethod PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  ledgerEntries LedgerEntry[]
  dispute       Dispute?
  order         Order?         @relation(fields: [orderId], references: [id])
  orderId       String?

  @@index([senderId])
  @@index([receiverId])
  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([referenceId])
}

// ============================================
// DISPUTES & CHARGEBACKS
// ============================================

model Dispute {
  id              String        @id @default(cuid())
  transactionId   String        @unique
  createdById     String
  respondentId    String?

  type            DisputeType
  status          DisputeStatus @default(OPEN)

  amount          Decimal       @db.Decimal(20, 8)
  currency        String

  reason          String
  description     String?

  // Evidence
  buyerEvidence   Json?
  sellerEvidence  Json?

  // Resolution
  resolvedAt      DateTime?
  resolvedBy      String?
  resolution      String?
  refundAmount    Decimal?      @db.Decimal(20, 8)

  // Deadlines
  sellerDeadline  DateTime?
  escalationDate  DateTime?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  transaction Transaction    @relation(fields: [transactionId], references: [id])
  createdBy   User           @relation("DisputeCreator", fields: [createdById], references: [id])
  respondent  User?          @relation("DisputeRespondent", fields: [respondentId], references: [id])
  messages    DisputeMessage[]

  @@index([createdById])
  @@index([respondentId])
  @@index([status])
}

model DisputeMessage {
  id          String   @id @default(cuid())
  disputeId   String
  senderId    String
  senderRole  String   // buyer, seller, admin
  message     String
  attachments String[]
  createdAt   DateTime @default(now())

  dispute Dispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  @@index([disputeId])
}

// ============================================
// RISK & FRAUD
// ============================================

model RiskProfile {
  id                String    @id @default(cuid())
  userId            String    @unique
  riskLevel         RiskLevel @default(LOW)
  riskScore         Float     @default(0)

  // Risk Factors
  accountAge        Int       @default(0) // days
  transactionCount  Int       @default(0)
  disputeCount      Int       @default(0)
  chargebackCount   Int       @default(0)

  // Velocity Checks
  dailyTransactionCount    Int     @default(0)
  dailyTransactionVolume   Decimal @db.Decimal(20, 8) @default(0)
  weeklyTransactionCount   Int     @default(0)
  weeklyTransactionVolume  Decimal @db.Decimal(20, 8) @default(0)
  monthlyTransactionCount  Int     @default(0)
  monthlyTransactionVolume Decimal @db.Decimal(20, 8) @default(0)

  // Limits
  dailyLimit        Decimal   @db.Decimal(20, 8) @default(1000)
  weeklyLimit       Decimal   @db.Decimal(20, 8) @default(5000)
  monthlyLimit      Decimal   @db.Decimal(20, 8) @default(20000)
  singleTxLimit     Decimal   @db.Decimal(20, 8) @default(500)

  // Flags
  isRestricted      Boolean   @default(false)
  restrictionReason String?

  lastUpdated       DateTime  @default(now())
  createdAt         DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RiskRule {
  id          String   @id @default(cuid())
  name        String
  description String?
  ruleType    String   // velocity, amount, country, device, pattern
  conditions  Json     // Rule conditions
  action      String   // allow, block, review, step_up
  priority    Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ComplianceAlert {
  id            String      @id @default(cuid())
  userId        String
  alertType     String      // sanctions_match, pep_match, suspicious_activity, high_risk_country
  status        AlertStatus @default(NEW)
  severity      RiskLevel

  title         String
  description   String
  details       Json?

  assignedTo    String?
  resolvedBy    String?
  resolvedAt    DateTime?
  resolution    String?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([alertType])
}

// ============================================
// MERCHANT / ORDERS
// ============================================

model Order {
  id                String      @id @default(cuid())
  orderNumber       String      @unique
  merchantId        String
  customerId        String?

  status            OrderStatus @default(PENDING)

  subtotal          Decimal     @db.Decimal(20, 8)
  tax               Decimal     @db.Decimal(20, 8) @default(0)
  shipping          Decimal     @db.Decimal(20, 8) @default(0)
  discount          Decimal     @db.Decimal(20, 8) @default(0)
  total             Decimal     @db.Decimal(20, 8)
  currency          String

  // Authorization
  authorizedAmount  Decimal?    @db.Decimal(20, 8)
  capturedAmount    Decimal?    @db.Decimal(20, 8)
  refundedAmount    Decimal?    @db.Decimal(20, 8)

  // Customer Info
  customerEmail     String
  customerName      String?
  customerPhone     String?
  shippingAddress   Json?
  billingAddress    Json?

  // Items
  items             Json        // Array of order items

  metadata          Json?
  notes             String?

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  merchant     Business      @relation(fields: [merchantId], references: [id])
  transactions Transaction[]

  @@index([merchantId])
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// PAYOUTS
// ============================================

model Payout {
  id              String       @id @default(cuid())
  businessId      String
  referenceId     String       @unique

  status          PayoutStatus @default(PENDING)

  amount          Decimal      @db.Decimal(20, 8)
  fee             Decimal      @db.Decimal(20, 8) @default(0)
  netAmount       Decimal      @db.Decimal(20, 8)
  currency        String

  // Destination
  destinationType String       // bank_account, wallet
  destinationId   String?
  destinationDetails Json?

  description     String?

  processedAt     DateTime?
  failureReason   String?
  externalRef     String?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  business Business @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([status])
}

// ============================================
// PRODUCTS
// ============================================

model Product {
  id            String   @id @default(cuid())
  businessId    String
  name          String
  description   String?
  sku           String?
  price         Decimal  @db.Decimal(20, 8)
  currency      String   @default("USD")
  category      String?
  imageUrl      String?
  inventory     Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id])

  @@unique([businessId, sku])
  @@index([businessId])
  @@index([isActive])
}

// ============================================
// SUBSCRIPTIONS & BILLING
// ============================================

model SubscriptionPlan {
  id            String   @id @default(cuid())
  businessId    String
  name          String
  description   String?

  price         Decimal  @db.Decimal(20, 8)
  currency      String   @default("USD")
  interval      String   // day, week, month, year
  intervalCount Int      @default(1)

  trialDays     Int      @default(0)
  features      Json?    // Array of feature strings

  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  business      Business       @relation(fields: [businessId], references: [id])
  subscriptions Subscription[]

  @@index([businessId])
}

model Subscription {
  id              String             @id @default(cuid())
  planId          String
  userId          String

  status          SubscriptionStatus @default(ACTIVE)

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  cancelledAt     DateTime?
  cancelAtPeriodEnd Boolean          @default(false)
  cancelReason    String?

  trialStart      DateTime?
  trialEnd        DateTime?

  metadata        Json?

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  plan SubscriptionPlan @relation(fields: [planId], references: [id])
  user User             @relation(fields: [userId], references: [id])

  @@index([planId])
  @@index([userId])
  @@index([status])
}

// ============================================
// INVOICING
// ============================================

model Invoice {
  id              String        @id @default(cuid())
  businessId      String
  invoiceNumber   String        @unique

  status          InvoiceStatus @default(DRAFT)

  customerId      String?
  customerEmail   String
  customerName    String?
  customerAddress Json?

  items           Json          // Line items
  subtotal        Decimal       @db.Decimal(20, 8)
  tax             Decimal       @db.Decimal(20, 8) @default(0)
  discount        Decimal       @db.Decimal(20, 8) @default(0)
  total           Decimal       @db.Decimal(20, 8)
  currency        String

  dueDate         DateTime?
  paidAt          DateTime?
  paidAmount      Decimal?      @db.Decimal(20, 8)

  notes           String?
  terms           String?

  sentAt          DateTime?
  viewedAt        DateTime?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  business Business @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([status])
}

// ============================================
// WEBHOOKS & API
// ============================================

model Webhook {
  id          String   @id @default(cuid())
  businessId  String
  url         String
  events      String[] // Array of event types
  secret      String
  isActive    Boolean  @default(true)

  lastTriggeredAt DateTime?
  failureCount    Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model APIKey {
  id          String   @id @default(cuid())
  userId      String
  name        String
  keyPrefix   String   // First 8 chars for display
  keyHash     String   // Hashed key
  permissions String[] // Array of permissions

  lastUsedAt  DateTime?
  expiresAt   DateTime?

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyHash])
}

// ============================================
// SUPPORT
// ============================================

model SupportTicket {
  id          String   @id @default(cuid())
  userId      String
  ticketNumber String  @unique

  subject     String
  description String
  category    String   // account, payment, dispute, technical, other
  priority    String   @default("normal") // low, normal, high, urgent
  status      String   @default("open") // open, in_progress, waiting, resolved, closed

  assignedTo  String?
  resolvedAt  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages TicketMessage[]

  @@index([userId])
  @@index([status])
}

model TicketMessage {
  id          String   @id @default(cuid())
  ticketId    String
  senderId    String
  senderRole  String   // user, agent, system
  message     String
  attachments String[]
  createdAt   DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

// ============================================
// ACTIVITY & AUDIT
// ============================================

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String   // login, logout, transaction, settings_change, etc.
  entityType  String?  // user, transaction, dispute, etc.
  entityId    String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  type        String   // transaction, security, marketing, system
  title       String
  message     String
  data        Json?
  isRead      Boolean  @default(false)
  readAt      DateTime?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String   // general, fees, limits, notifications, compliance
  updatedBy String?
  updatedAt DateTime @updatedAt
}

model SystemSettings {
  id                          String   @id @default(cuid())

  // Platform Settings
  platformName                String   @default("Xfer")
  supportEmail                String   @default("support@xfer.com")
  defaultCurrency             String   @default("USD")
  defaultTimezone             String   @default("UTC")
  maintenanceMode             Boolean  @default(false)
  newUserRegistrations        Boolean  @default(true)

  // Transaction Limits
  dailyTransferLimitUnverified  Int    @default(500)
  dailyTransferLimitVerified    Int    @default(10000)
  singleTransactionLimit        Int    @default(5000)
  monthlyTransactionLimit       Int    @default(50000)

  // Security Settings
  require2FAForAdmins         Boolean  @default(true)
  sessionTimeoutMinutes       Int      @default(30)
  ipWhitelisting              Boolean  @default(false)
  failedLoginLockout          Boolean  @default(true)
  maxFailedLoginAttempts      Int      @default(5)
  lockoutDurationMinutes      Int      @default(15)

  // Notification Settings
  emailNotifications          Boolean  @default(true)
  smsNotifications            Boolean  @default(false)
  slackIntegration            Boolean  @default(false)
  slackWebhookUrl             String?

  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
}

model Currency {
  code      String   @id
  name      String
  symbol    String
  decimals  Int      @default(2)
  isActive  Boolean  @default(true)
}

model ExchangeRate {
  id           String   @id @default(cuid())
  fromCurrency String
  toCurrency   String
  rate         Decimal  @db.Decimal(20, 8)
  spread       Decimal  @db.Decimal(10, 4) @default(0)
  validFrom    DateTime @default(now())
  validUntil   DateTime?

  @@unique([fromCurrency, toCurrency, validFrom])
  @@index([fromCurrency, toCurrency])
}

model FeeStructure {
  id           String   @id @default(cuid())
  name         String
  description  String?
  feeType      String   // percentage, fixed, tiered

  // For simple fees
  percentage   Decimal? @db.Decimal(10, 4)
  fixedAmount  Decimal? @db.Decimal(20, 8)
  currency     String?

  // For tiered fees
  tiers        Json?    // Array of tier objects

  minFee       Decimal? @db.Decimal(20, 8)
  maxFee       Decimal? @db.Decimal(20, 8)

  appliesTo    String[] // transaction types
  isActive     Boolean  @default(true)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ============================================
// MONEY REQUESTS
// ============================================

model MoneyRequest {
  id            String             @id @default(cuid())
  requesterId   String
  requesteeId   String
  amount        Decimal            @db.Decimal(20, 8)
  currency      String             @default("USD")
  note          String?
  status        MoneyRequestStatus @default(PENDING)
  transactionId String?
  expiresAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  requester     User               @relation("RequestsSent", fields: [requesterId], references: [id])
  requestee     User               @relation("RequestsReceived", fields: [requesteeId], references: [id])

  @@index([requesterId])
  @@index([requesteeId])
  @@index([status])
}

// ============================================
// COMPANY BANK ACCOUNTS (Platform's own accounts)
// ============================================

model CompanyBankAccount {
  id              String   @id @default(cuid())
  accountName     String
  bankName        String
  bankCountry     String
  currency        String
  accountNumber   String   // Encrypted
  routingNumber   String?
  swiftCode       String?
  iban            String?
  accountType     String   // operating, reserve, settlement

  // Balance tracking
  balance         Decimal  @db.Decimal(20, 8) @default(0)
  lastReconciled  DateTime?

  // For payment processing
  isActive        Boolean  @default(true)
  isPrimary       Boolean  @default(false)
  dailyLimit      Decimal  @db.Decimal(20, 8) @default(1000000)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  deposits        CompanyDeposit[]
  withdrawals     CompanyWithdrawal[]
  settlements     SettlementBatch[]
  ledgerEntries   CompanyLedgerEntry[]

  @@index([currency])
  @@index([isActive])
}

model CompanyLedgerEntry {
  id              String   @id @default(cuid())
  accountId       String
  entryType       String   // debit, credit
  amount          Decimal  @db.Decimal(20, 8)
  balanceBefore   Decimal  @db.Decimal(20, 8)
  balanceAfter    Decimal  @db.Decimal(20, 8)
  description     String
  reference       String?
  relatedType     String?  // deposit, withdrawal, settlement, fee
  relatedId       String?
  createdAt       DateTime @default(now())

  account CompanyBankAccount @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@index([createdAt])
}

model CompanyDeposit {
  id              String   @id @default(cuid())
  accountId       String
  userId          String
  transactionId   String?
  amount          Decimal  @db.Decimal(20, 8)
  currency        String
  status          String   @default("PENDING") // PENDING, COMPLETED, FAILED
  depositMethod   String   // wire, ach, card
  reference       String   @unique
  externalRef     String?
  processedAt     DateTime?
  failureReason   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  account CompanyBankAccount @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@index([userId])
  @@index([status])
}

model CompanyWithdrawal {
  id              String   @id @default(cuid())
  accountId       String
  userId          String
  transactionId   String?
  amount          Decimal  @db.Decimal(20, 8)
  currency        String
  status          String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  withdrawalMethod String  // wire, ach
  reference       String   @unique
  externalRef     String?
  processedAt     DateTime?
  failureReason   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  account CompanyBankAccount @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@index([userId])
  @@index([status])
}

// ============================================
// BATCH PAYMENTS & SCHEDULED PAYMENTS
// ============================================

model BatchPayout {
  id              String   @id @default(cuid())
  businessId      String
  batchReference  String   @unique
  status          String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, PARTIALLY_COMPLETED, FAILED

  totalAmount     Decimal  @db.Decimal(20, 8)
  totalFees       Decimal  @db.Decimal(20, 8) @default(0)
  currency        String

  itemCount       Int
  successCount    Int      @default(0)
  failedCount     Int      @default(0)

  description     String?
  processedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  items           BatchPayoutItem[]

  @@index([businessId])
  @@index([status])
}

model BatchPayoutItem {
  id              String   @id @default(cuid())
  batchId         String
  recipientEmail  String
  recipientId     String?
  amount          Decimal  @db.Decimal(20, 8)
  currency        String
  status          String   @default("PENDING") // PENDING, COMPLETED, FAILED
  note            String?
  transactionId   String?
  failureReason   String?
  processedAt     DateTime?
  createdAt       DateTime @default(now())

  batch BatchPayout @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([recipientId])
}

model ScheduledPayment {
  id              String   @id @default(cuid())
  userId          String
  recipientId     String?
  recipientEmail  String
  amount          Decimal  @db.Decimal(20, 8)
  currency        String   @default("USD")
  note            String?

  // Schedule
  frequency       String   // once, daily, weekly, biweekly, monthly, quarterly, yearly
  nextRunDate     DateTime
  lastRunDate     DateTime?
  endDate         DateTime?

  // Status
  status          String   @default("ACTIVE") // ACTIVE, PAUSED, COMPLETED, CANCELLED
  runCount        Int      @default(0)
  maxRuns         Int?     // null = unlimited

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  executions      ScheduledPaymentExecution[]

  @@index([userId])
  @@index([status])
  @@index([nextRunDate])
}

model ScheduledPaymentExecution {
  id              String   @id @default(cuid())
  scheduledPaymentId String
  transactionId   String?
  status          String   // SUCCESS, FAILED
  amount          Decimal  @db.Decimal(20, 8)
  failureReason   String?
  executedAt      DateTime @default(now())

  scheduledPayment ScheduledPayment @relation(fields: [scheduledPaymentId], references: [id], onDelete: Cascade)

  @@index([scheduledPaymentId])
}

// ============================================
// QR CODE PAYMENTS
// ============================================

model QRPayment {
  id              String   @id @default(cuid())
  userId          String
  qrCode          String   @unique
  type            String   // receive, pay, merchant

  amount          Decimal? @db.Decimal(20, 8) // null = any amount
  currency        String   @default("USD")
  description     String?

  // Limits
  usageLimit      Int?     // null = unlimited
  usageCount      Int      @default(0)
  expiresAt       DateTime?

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([qrCode])
}

// ============================================
// SHOPPING CART & COUPONS
// ============================================

model Cart {
  id              String   @id @default(cuid())
  userId          String?
  sessionId       String?
  merchantId      String

  subtotal        Decimal  @db.Decimal(20, 8) @default(0)
  tax             Decimal  @db.Decimal(20, 8) @default(0)
  discount        Decimal  @db.Decimal(20, 8) @default(0)
  total           Decimal  @db.Decimal(20, 8) @default(0)
  currency        String   @default("USD")

  couponId        String?

  expiresAt       DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  items           CartItem[]
  coupon          Coupon?  @relation(fields: [couponId], references: [id])

  @@index([userId])
  @@index([sessionId])
  @@index([merchantId])
}

model CartItem {
  id              String   @id @default(cuid())
  cartId          String
  productId       String?
  name            String
  description     String?
  quantity        Int
  unitPrice       Decimal  @db.Decimal(20, 8)
  total           Decimal  @db.Decimal(20, 8)
  metadata        Json?
  createdAt       DateTime @default(now())

  cart Cart @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@index([cartId])
}

model Coupon {
  id              String   @id @default(cuid())
  businessId      String
  code            String
  description     String?

  discountType    String   // percentage, fixed
  discountValue   Decimal  @db.Decimal(20, 8)
  currency        String?  // Required for fixed discount

  minPurchase     Decimal? @db.Decimal(20, 8)
  maxDiscount     Decimal? @db.Decimal(20, 8)

  usageLimit      Int?
  usageCount      Int      @default(0)
  perUserLimit    Int      @default(1)

  validFrom       DateTime @default(now())
  validUntil      DateTime?

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  carts           Cart[]
  usages          CouponUsage[]

  @@unique([businessId, code])
  @@index([businessId])
  @@index([code])
}

model CouponUsage {
  id              String   @id @default(cuid())
  couponId        String
  userId          String
  orderId         String?
  discountAmount  Decimal  @db.Decimal(20, 8)
  usedAt          DateTime @default(now())

  coupon Coupon @relation(fields: [couponId], references: [id])

  @@index([couponId])
  @@index([userId])
}

model TaxRate {
  id              String   @id @default(cuid())
  country         String
  state           String?
  city            String?
  postalCode      String?

  taxType         String   // sales_tax, vat, gst
  rate            Decimal  @db.Decimal(10, 4)
  name            String

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([country, state])
}

model AbandonedCart {
  id              String   @id @default(cuid())
  cartId          String
  userId          String?
  email           String?

  remindersSent   Int      @default(0)
  lastReminderAt  DateTime?
  recoveredAt     DateTime?
  orderId         String?

  cartData        Json     // Snapshot of cart

  createdAt       DateTime @default(now())

  @@index([email])
  @@index([userId])
}

// ============================================
// CHARGEBACKS & SELLER RATINGS
// ============================================

model Chargeback {
  id              String   @id @default(cuid())
  transactionId   String   @unique
  disputeId       String?

  amount          Decimal  @db.Decimal(20, 8)
  currency        String

  reasonCode      String
  reason          String

  status          String   @default("OPEN") // OPEN, REPRESENTMENT, WON, LOST, ACCEPTED

  // Evidence
  merchantEvidence Json?
  issuerEvidence   Json?

  // Deadlines
  responseDeadline DateTime?
  arbitrationDeadline DateTime?

  // Fees
  chargebackFee   Decimal  @db.Decimal(20, 8) @default(15)
  reversalFee     Decimal? @db.Decimal(20, 8)

  resolvedAt      DateTime?
  resolution      String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([transactionId])
  @@index([status])
}

model SellerRating {
  id              String   @id @default(cuid())
  sellerId        String
  buyerId         String
  transactionId   String   @unique

  rating          Int      // 1-5
  review          String?

  // Breakdown
  itemAccuracy    Int?     // 1-5
  communication   Int?     // 1-5
  shippingSpeed   Int?     // 1-5

  isVisible       Boolean  @default(true)
  sellerResponse  String?
  respondedAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sellerId])
  @@index([buyerId])
}

model SellerScore {
  id              String   @id @default(cuid())
  sellerId        String   @unique

  averageRating   Decimal  @db.Decimal(3, 2) @default(0)
  totalRatings    Int      @default(0)
  totalSales      Int      @default(0)

  // Trust factors
  disputeRate     Decimal  @db.Decimal(5, 4) @default(0)
  chargebackRate  Decimal  @db.Decimal(5, 4) @default(0)
  refundRate      Decimal  @db.Decimal(5, 4) @default(0)
  responseTime    Int      @default(0) // average hours

  // Badge
  sellerLevel     String   @default("NEW") // NEW, BRONZE, SILVER, GOLD, PLATINUM

  lastCalculated  DateTime @default(now())

  @@index([sellerId])
  @@index([sellerLevel])
}

// ============================================
// COMPLIANCE & REGULATORY
// ============================================

model SanctionsList {
  id              String   @id @default(cuid())
  listType        String   // OFAC, UN, EU, UK
  entityType      String   // individual, organization
  name            String
  aliases         String[]
  countries       String[]
  identifiers     Json?    // passport numbers, tax IDs, etc.
  dateOfBirth     String?
  addedDate       DateTime
  lastUpdated     DateTime

  @@index([name])
  @@index([listType])
}

model SanctionsScreening {
  id              String   @id @default(cuid())
  userId          String
  screeningType   String   // onboarding, transaction, periodic

  matchFound      Boolean  @default(false)
  matchDetails    Json?

  status          String   @default("CLEAR") // CLEAR, POTENTIAL_MATCH, CONFIRMED_MATCH, FALSE_POSITIVE
  reviewedBy      String?
  reviewedAt      DateTime?
  notes           String?

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([status])
}

model GDPRRequest {
  id              String   @id @default(cuid())
  userId          String
  requestType     String   // export, delete, rectify, restrict
  status          String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, REJECTED

  requestDetails  Json?

  // For export requests
  exportUrl       String?
  exportExpiresAt DateTime?

  // For deletion requests
  deletionScope   String[] // Array of data categories to delete

  processedBy     String?
  processedAt     DateTime?
  rejectionReason String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model RegulatoryReport {
  id              String   @id @default(cuid())
  reportType      String   // SAR, CTR, STR, ANNUAL, QUARTERLY
  jurisdiction    String

  reportingPeriod String?
  startDate       DateTime?
  endDate         DateTime?

  status          String   @default("DRAFT") // DRAFT, PENDING_REVIEW, SUBMITTED, ACKNOWLEDGED

  reportData      Json
  fileUrl         String?

  submittedAt     DateTime?
  submittedBy     String?
  acknowledgementRef String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([reportType])
  @@index([status])
}

// ============================================
// SETTLEMENT & RECONCILIATION
// ============================================

model SettlementBatch {
  id              String   @id @default(cuid())
  batchReference  String   @unique
  companyAccountId String

  status          String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED

  settlementDate  DateTime
  cutoffTime      DateTime

  totalCredits    Decimal  @db.Decimal(20, 8) @default(0)
  totalDebits     Decimal  @db.Decimal(20, 8) @default(0)
  netAmount       Decimal  @db.Decimal(20, 8) @default(0)
  currency        String

  transactionCount Int     @default(0)

  processedAt     DateTime?
  failureReason   String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  companyAccount  CompanyBankAccount @relation(fields: [companyAccountId], references: [id])
  items           SettlementItem[]

  @@index([status])
  @@index([settlementDate])
}

model SettlementItem {
  id              String   @id @default(cuid())
  batchId         String
  transactionId   String

  amount          Decimal  @db.Decimal(20, 8)
  fee             Decimal  @db.Decimal(20, 8) @default(0)
  netAmount       Decimal  @db.Decimal(20, 8)

  status          String   @default("PENDING") // PENDING, SETTLED, FAILED
  settledAt       DateTime?

  batch SettlementBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([transactionId])
}

model ReconciliationReport {
  id              String   @id @default(cuid())
  reportDate      DateTime
  accountId       String

  status          String   @default("PENDING") // PENDING, IN_PROGRESS, BALANCED, DISCREPANCY

  // Expected (from our ledger)
  expectedBalance Decimal  @db.Decimal(20, 8)
  expectedTransactions Int

  // Actual (from bank statement)
  actualBalance   Decimal? @db.Decimal(20, 8)
  actualTransactions Int?

  // Discrepancies
  discrepancyAmount Decimal? @db.Decimal(20, 8)
  discrepancyItems Json?

  reconciledBy    String?
  reconciledAt    DateTime?
  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([reportDate])
  @@index([accountId])
  @@index([status])
}

model TaxDocument {
  id              String   @id @default(cuid())
  userId          String
  taxYear         Int
  documentType    String   // 1099K, 1099MISC, W9, VAT_INVOICE

  // Recipient info
  recipientName   String
  recipientTin    String?  // Encrypted
  recipientAddress Json

  // Amounts
  grossAmount     Decimal  @db.Decimal(20, 8)
  transactionCount Int

  // Document
  fileUrl         String?
  generatedAt     DateTime?
  mailedAt        DateTime?

  status          String   @default("PENDING") // PENDING, GENERATED, SENT, CORRECTED

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, taxYear, documentType])
  @@index([userId])
  @@index([taxYear])
}

// ============================================
// DEVELOPER PLATFORM (OAuth, Rate Limiting)
// ============================================

model OAuthClient {
  id              String   @id @default(cuid())
  userId          String
  clientId        String   @unique
  clientSecret    String   // Hashed

  name            String
  description     String?
  logoUrl         String?
  websiteUrl      String?

  redirectUris    String[]
  scopes          String[]

  isConfidential  Boolean  @default(true)
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tokens          OAuthToken[]
  authCodes       OAuthAuthorizationCode[]

  @@index([userId])
  @@index([clientId])
}

model OAuthAuthorizationCode {
  id              String   @id @default(cuid())
  clientId        String
  userId          String
  code            String   @unique
  scopes          String[]
  redirectUri     String
  codeChallenge   String?  // For PKCE
  codeChallengeMethod String? // plain or S256
  expiresAt       DateTime
  createdAt       DateTime @default(now())

  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([code])
}

model OAuthToken {
  id              String   @id @default(cuid())
  clientId        String
  userId          String

  accessToken     String   @unique
  refreshToken    String?  @unique

  scopes          String[]

  accessTokenExpiresAt  DateTime
  refreshTokenExpiresAt DateTime?

  revokedAt       DateTime?
  createdAt       DateTime @default(now())

  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([accessToken])
  @@index([refreshToken])
  @@index([userId])
}

model RateLimitRule {
  id              String   @id @default(cuid())
  name            String
  endpoint        String   // API endpoint pattern

  windowSeconds   Int      // Time window in seconds
  maxRequests     Int      // Max requests per window

  scope           String   // global, user, ip, api_key

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([endpoint])
}

model RateLimitLog {
  id              String   @id @default(cuid())
  identifier      String   // user ID, IP, or API key
  endpoint        String
  requestCount    Int      @default(1)
  windowStart     DateTime
  blocked         Boolean  @default(false)

  @@unique([identifier, endpoint, windowStart])
  @@index([identifier])
  @@index([windowStart])
}

model WebhookDelivery {
  id              String   @id @default(cuid())
  webhookId       String
  eventType       String
  payload         Json

  status          String   @default("PENDING") // PENDING, SUCCESS, FAILED

  // Delivery attempts
  attemptCount    Int      @default(0)
  maxAttempts     Int      @default(5)

  // Response
  responseStatus  Int?
  responseBody    String?
  responseTime    Int?     // ms

  nextRetryAt     DateTime?
  deliveredAt     DateTime?
  failureReason   String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([webhookId])
  @@index([status])
  @@index([nextRetryAt])
}

// ============================================
// CUSTOMER SUPPORT (Live Chat, Knowledge Base, SLA)
// ============================================

model ChatSession {
  id              String   @id @default(cuid())
  userId          String
  agentId         String?

  status          String   @default("WAITING") // WAITING, ACTIVE, CLOSED

  startedAt       DateTime @default(now())
  endedAt         DateTime?

  rating          Int?
  feedback        String?

  metadata        Json?

  messages        ChatMessage[]

  @@index([userId])
  @@index([agentId])
  @@index([status])
}

model ChatMessage {
  id              String   @id @default(cuid())
  sessionId       String
  senderId        String
  senderType      String   // user, agent, bot

  message         String
  attachments     String[]

  isRead          Boolean  @default(false)
  readAt          DateTime?

  createdAt       DateTime @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model KnowledgeArticle {
  id              String   @id @default(cuid())
  slug            String   @unique
  title           String
  content         String
  excerpt         String?

  category        String
  tags            String[]

  viewCount       Int      @default(0)
  helpfulCount    Int      @default(0)
  notHelpfulCount Int      @default(0)

  status          String   @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED
  publishedAt     DateTime?

  authorId        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([category])
  @@index([status])
}

model SLAPolicy {
  id              String   @id @default(cuid())
  name            String
  description     String?

  priority        String   // low, normal, high, urgent

  // Response times (in minutes)
  firstResponseTime Int
  resolutionTime    Int

  // Escalation
  escalateAfter     Int?   // minutes
  escalateTo        String? // team or role

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model SLABreach {
  id              String   @id @default(cuid())
  ticketId        String
  policyId        String
  breachType      String   // first_response, resolution
  breachedAt      DateTime
  resolvedAt      DateTime?

  @@index([ticketId])
}

// ============================================
// ADVANCED RISK & FRAUD
// ============================================

model IPGeolocation {
  id              String   @id @default(cuid())
  ipAddress       String   @unique
  country         String
  countryCode     String
  region          String?
  city            String?
  latitude        Decimal? @db.Decimal(10, 8)
  longitude       Decimal? @db.Decimal(11, 8)
  isp             String?
  isProxy         Boolean  @default(false)
  isVpn           Boolean  @default(false)
  isTor           Boolean  @default(false)
  threatLevel     String   @default("LOW") // LOW, MEDIUM, HIGH
  lastUpdated     DateTime @default(now())

  @@index([country])
  @@index([threatLevel])
}

model BehavioralProfile {
  id              String   @id @default(cuid())
  userId          String   @unique

  // Typical behavior patterns
  typicalLoginTimes     Json?  // Array of typical hours
  typicalDevices        String[]
  typicalIpCountries    String[]
  typicalTransactionAmounts Json? // min, max, avg

  // Anomaly detection
  lastAnomalyScore      Float   @default(0)
  anomalyFlags          String[]

  lastUpdated           DateTime @default(now())
}

model FraudSignal {
  id              String   @id @default(cuid())
  userId          String?
  transactionId   String?
  sessionId       String?

  signalType      String   // velocity, device, location, behavior, network
  signalName      String
  severity        String   // LOW, MEDIUM, HIGH, CRITICAL

  details         Json
  score           Float

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([transactionId])
  @@index([signalType])
}

model FraudNetwork {
  id              String   @id @default(cuid())
  networkType     String   // device, email_domain, ip_range, phone_prefix
  identifier      String

  riskScore       Float    @default(0)
  linkedUsers     String[]
  linkedTransactions String[]

  notes           String?
  flaggedAt       DateTime?
  flaggedBy       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([networkType, identifier])
  @@index([riskScore])
}

model PhoneVerification {
  id              String   @id @default(cuid())
  userId          String
  phone           String
  code            String

  status          String   @default("PENDING") // PENDING, VERIFIED, EXPIRED, FAILED
  attempts        Int      @default(0)
  maxAttempts     Int      @default(3)

  expiresAt       DateTime
  verifiedAt      DateTime?

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([phone])
}
